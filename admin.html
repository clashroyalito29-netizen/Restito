<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Cocina & Staff</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-grid { display: grid; grid-template-columns: 250px 1fr; height: 100vh; }
        .sidebar { background: rgba(0,0,0,0.3); padding: 20px; border-right: 1px solid rgba(255,255,255,0.1); }
        .order-card { background: rgba(56, 189, 248, 0.1); border-left: 4px solid var(--accent); margin-bottom: 10px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="admin-grid">
        <div class="sidebar">
            <h3>Mesas</h3>
            <div id="mesas-list" style="display: flex; flex-direction: column; gap: 10px;">
                </div>
        </div>

        <div style="padding: 20px; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between;">
                <h2>Pedidos en Curso</h2>
                <div id="clock">00:00</div>
            </div>
            <div id="orders-container">
                </div>
        </div>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3"></audio>

    <script type="module">
        import { supabase } from './supabase-client.js';

        // 1. Cargar y Controlar Mesas
        async function loadMesas() {
            const { data } = await supabase.from('mesas').select('*').order('numero_mesa');
            const container = document.getElementById('mesas-list');
            container.innerHTML = '';
            
            data.forEach(mesa => {
                const isBusy = mesa.estado === 'OCUPADA';
                const color = isBusy ? '#ef4444' : '#10b981'; // Rojo o Verde
                
                const btn = document.createElement('div');
                btn.className = 'glass-card';
                btn.style.borderColor = color;
                btn.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <span>Mesa ${mesa.numero_mesa}</span>
                        <div style="width:10px; height:10px; border-radius:50%; background:${color}"></div>
                    </div>
                    <small style="color:var(--text-muted)">${mesa.estado}</small>
                `;
                // Click para alternar estado (Toggle)
                btn.onclick = async () => toggleMesa(mesa.id, mesa.estado);
                container.appendChild(btn);
            });
        }

        async function toggleMesa(id, currentState) {
            const newState = currentState === 'LIBRE' ? 'OCUPADA' : 'LIBRE';
            await supabase.from('mesas').update({ estado: newState }).eq('id', id);
            loadMesas(); // Recargar UI
        }

        // 2. Monitor de Pedidos en Tiempo Real
        function subscribeToOrders() {
            const container = document.getElementById('orders-container');

            // Suscripción
            supabase.channel('kitchen-orders')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pedidos' }, payload => {
                    // Nuevo pedido entrante!
                    document.getElementById('alert-sound').play();
                    renderOrder(payload.new, true);
                })
                .subscribe();

            // Cargar iniciales
            loadPendingOrders();
        }

        async function loadPendingOrders() {
            const { data } = await supabase.from('pedidos')
                .select('*')
                .neq('estado', 'ENTREGADO') // Solo mostrar pendientes
                .order('created_at', { ascending: false });
            
            data.forEach(order => renderOrder(order));
        }

        function renderOrder(order, animate = false) {
            const container = document.getElementById('orders-container');
            const card = document.createElement('div');
            card.className = `glass-card order-card ${animate ? 'animate-enter' : ''}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>Mesa #${order.mesa_id}</strong> <span>$${order.total}</span>
                </div>
                <div style="margin: 10px 0; font-size: 0.9em; color: var(--text-muted)">
                    ${order.items.map(i => `• ${i.nombre} (x${i.cantidad || 1})`).join('<br>')}
                </div>
                <div style="display:flex; gap: 10px; margin-top:10px;">
                    <button class="btn-primary" style="background: var(--success); padding: 5px;">Completar</button>
                </div>
            `;
            container.prepend(card);
        }

        // Init
        loadMesas();
        subscribeToOrders();
    </script>
</body>
</html>

